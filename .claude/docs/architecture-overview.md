# 漏洞复现智能体架构方案

> 版本: v2.0
> 更新时间: 2026-01-08
> 目的: 老板对齐会议

---

## 一、核心问题

### 1.1 原有问题

| 问题 | 影响 |
|------|------|
| AI 复现不可控 | 可能伪造/跳过步骤，造成虚假复现 |
| Playwright 黑盒成功率低 | 不知道点什么、准备什么数据 |
| 报告证据不足 | 不知道什么是利用成功、该截什么图 |

### 1.2 老板方向

> "不要上来做黑盒渗透测试这类比较重的，应该先做简单精确的"
> "分析代码模块，mock 出来单独测"
> "后面应该是两个模式"

---

## 二、解决方案：三层复现模式

```
┌─────────────────────────────────────────────────────────────┐
│                     漏洞复现智能体                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────┐    ┌─────────┐    ┌─────────┐               │
│   │   L1    │    │   L2    │    │   L3    │               │
│   │Playwright│   │  API   │    │  Mock   │               │
│   │  黑盒   │    │ 接口   │    │ 代码   │               │
│   └────┬────┘    └────┬────┘    └────┬────┘               │
│        │              │              │                     │
│        ▼              ▼              ▼                     │
│   简单漏洞        有API漏洞      复杂漏洞                  │
│   页面操作        接口层面       需源码                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.1 模式对比

| 层级 | 模式 | 适用场景 | 复杂度 | 成功率 |
|------|------|---------|--------|--------|
| **L1** | Playwright 黑盒 | 简单页面操作漏洞 | 低 | 中 |
| **L2** | API 接口复现 | 有明确 API 的漏洞 | 中 | 高 |
| **L3** | Mock 代码模块 | 复杂前提条件漏洞 | 高 | 高* |

> *L3 成功率高但需标注局限性

### 2.2 模式选择逻辑

```
分析漏洞报告
      │
      ▼
┌─────────────────────────────────────┐
│ 判断条件：                          │
│ • 步骤复杂度                        │
│ • 是否有 API 端点                   │
│ • 前提条件                          │
│ • 是否有源码                        │
└─────────────────────────────────────┘
      │
      ├─── 简单 + 页面操作 ──────► L1
      │
      ├─── 有 API 端点 ──────────► L2
      │
      └─── 复杂 + 有源码 ────────► L3
```

### 2.3 降级机制

```
L1 失败 ──► 有API? ──► L2
              │
              └─► 有源码? ──► L3
                      │
                      └─► 标记失败

L2 失败 ──► 有源码? ──► L3
              │
              └─► 标记失败

L3 失败 ──► 标记失败（记录详细原因）
```

---

## 三、L1 Playwright 优化（重点）

### 3.1 原有问题

- 找不到页面元素
- 不知道前置操作
- 页面跳转后迷失

### 3.2 解决方案：探索模式

```
执行步骤
    │
    ▼
卡住？──否──► 截图 ──► 下一步
    │
    是
    ▼
┌─────────────────────────┐
│      探索模式           │
├─────────────────────────┤
│ 1. 抓取 DOM 结构        │
│ 2. AI 分析匹配目标      │
│ 3. 找不到? 探索性点击   │
│ 4. 最多尝试 5 次        │
└─────────────────────────┘
    │
    ▼
找到？──是──► 继续执行
    │
    否
    ▼
记录失败 + 截图 + 尝试下一步
```

### 3.3 卡住判断条件

| 条件 | 处理 |
|------|------|
| 找不到元素（selector 失败） | 进入探索模式 |
| 点击后页面没变化 | 进入探索模式 |
| 出现预期外页面（报错/登录） | 检查是否需重新登录 |
| 执行超时 | 截图记录，尝试下一步 |

---

## 四、L2 API 复现

### 4.1 执行流程

```
从漏洞报告提取 API 信息
         │
         ▼
    获取认证凭据
         │
         ▼
    构造攻击请求
         │
         ▼
      发送请求
         │
         ▼
    验证响应特征
         │
         ├─ 成功 ──► 尝试 Playwright 截图
         │               │
         │               ├─ 截图成功 ──► 完成
         │               │
         │               └─ 截图失败 ──► 用 API 响应作证据
         │
         └─ 失败 ──► 返回失败信息（可降级到 L3）
```

### 4.2 证据要求

- HTTP 请求/响应完整记录
- 尽量获取页面截图
- 实在无法截图时，API 响应也可作为证据

---

## 五、L3 Mock 代码测试

### 5.1 核心思路

> 对应老板说的："分析代码模块，mock 出来单独测"

```
获取源码
   │
   ├─ Docker 环境 ──► 从容器提取
   │
   └─ 环境链接 ──► 用户提供路径
         │
         ▼
    定位漏洞代码
         │
         ▼
    分析依赖关系
         │
         ▼
   构造 Mock 环境
   ┌─────────────────────────┐
   │ • Mock 数据库连接       │
   │ • Mock 认证/权限检查    │
   │ • Mock 外部服务         │
   └─────────────────────────┘
         │
         ▼
    执行单元测试
         │
         ▼
    验证漏洞存在
```

### 5.2 局限性声明（重要）

**每个 L3 复现必须标注：**

```
┌────────────────────────────────────────────────────────┐
│  验证方式: Mock 单独代码测试                           │
│                                                        │
│  注意: 可能缺失全局性数据校验，需完整真实环境验证      │
│                                                        │
│  局限性:                                               │
│  • 绕过了认证/权限检查                                 │
│  • 可能缺失上层过滤逻辑                                │
│  • 未包含 WAF/安全中间件                               │
│  • 真实环境中可能无法利用                              │
└────────────────────────────────────────────────────────┘
```

### 5.3 与真实环境的关系

```
Mock 验证 ─────► "代码层面有漏洞"
                      │
                      ▼
            真实环境可能因防护而无法利用
                      │
                      ▼
            标记为 CONFIRMED_MOCK（非 CONFIRMED）
```

---

## 六、智能体架构

### 6.1 组件关系

```
┌─────────────────────────────────────────────────────────────┐
│                    /vuln-reproduce 命令                     │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                 reproduce-orchestrator                       │
│                     (编排智能体)                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ • 解析漏洞报告                                       │   │
│  │ • 选择复现模式                                       │   │
│  │ • 协调子智能体                                       │   │
│  │ • 处理模式降级                                       │   │
│  │ • 生成汇总报告                                       │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
          │                    │                    │
          ▼                    ▼                    ▼
   ┌────────────┐      ┌────────────┐      ┌────────────┐
   │ playwright │      │    api     │      │   mock     │
   │  executor  │      │ reproducer │      │  tester    │
   │   (L1)     │      │   (L2)     │      │   (L3)     │
   └────────────┘      └────────────┘      └────────────┘
          │                    │                    │
          ▼                    ▼                    ▼
   ┌─────────────────────────────────────────────────────┐
   │                   vuln-verifier                      │
   │                  (验证 + 报告生成)                   │
   └─────────────────────────────────────────────────────┘
```

### 6.2 辅助智能体

| 智能体 | 职责 |
|--------|------|
| env-builder | 环境搭建、技术栈识别 |
| data-preparer | 测试数据准备、会话管理 |

---

## 七、输入输出

### 7.1 输入

```yaml
必需:
  - 漏洞报告（md 文档，含漏洞描述 + PoC）
  - 环境地址 或 docker-compose.yml

可选:
  - 账号密码（管理员/普通用户）
  - 源码路径（L3 模式需要）
```

### 7.2 输入处理

```
AI 分析漏洞报告
        │
        ▼
检查缺失信息
        │
        ├─ 需要管理员权限但没凭据? ──► 询问用户
        │
        ├─ L3 需要源码但没提供? ──► 询问用户 / 从 Docker 提取
        │
        └─ 需要特定测试数据? ──► 询问用户
```

### 7.3 输出

```
.workspace/reproduced/{项目名}/
├── verdict.md                  # 汇总报告
├── individual_reports/         # 独立报告
│   └── {VULN_ID}_{名称}.md
├── poc/                        # PoC 脚本
│   └── {VULN_ID}_poc.py
└── evidence/                   # 证据
    └── {VULN_ID}/
        ├── screenshots/
        └── http/
```

### 7.4 判定结果

| 结果 | 含义 |
|------|------|
| **CONFIRMED** | L1/L2 复现成功 |
| **CONFIRMED_MOCK** | L3 复现成功（需注明局限性） |
| **NOT_REPRODUCED** | 所有模式均失败 |
| **PARTIAL** | 部分复现成功 |

---

## 八、与老板方案的对应

| 老板要求 | 方案实现 |
|---------|---------|
| "先做简单精确的" | L2 API 复现优先，精准请求 |
| "分析代码模块，mock 出来单独测" | L3 Mock 代码测试 |
| "不要上来做黑盒渗透测试" | L1 Playwright 仅用于简单漏洞 |
| "后面应该是两个模式" | 三层模式（L1 简单黑盒 / L2 API / L3 Mock） |
| "管理员 RCE 也是漏洞" | L3 Mock 可绕过权限验证代码层漏洞 |

---

## 九、关键设计决策

### 9.1 模式选择自动化

- AI 根据漏洞特征自动判断
- 支持降级重试
- 不需要用户手动指定

### 9.2 L1 探索机制

- 先执行，卡住时再探索
- 抓 DOM + AI 分析
- 探索性点击最多 5 次
- 失败后继续下一步（不阻塞）

### 9.3 L3 局限性标记

- Mock 成功 ≠ 真实环境可利用
- 必须标注 "CONFIRMED_MOCK"
- 必须说明缺失了什么

### 9.4 输入主动补全

- AI 分析后发现缺失信息
- 主动询问用户
- 不猜测、不跳过

---

## 十、后续规划

### 10.1 本次聚焦

- ✅ 三层复现模式
- ✅ L1 探索机制
- ✅ L3 局限性标记
- ✅ 输入完整性检查

### 10.2 后续迭代

| 优先级 | 内容 |
|--------|------|
| P1 | AI 判断"什么是利用成功" |
| P1 | 报告输出优化、证据增强 |
| P2 | 漏洞类型→操作模式知识库 |
| P2 | 截图取证策略优化 |

---

## 附录：文件清单

```
.claude/
├── commands/
│   └── vuln-reproduce.md        # 主命令
├── agents/
│   ├── reproduce-orchestrator.md # 编排智能体
│   ├── vuln-verifier.md          # 验证智能体
│   ├── playwright-executor.md    # L1 执行器
│   ├── api-reproducer.md         # L2 执行器
│   ├── mock-tester.md            # L3 执行器
│   ├── env-builder.md            # 环境搭建
│   └── data-preparer.md          # 数据准备
└── docs/
    └── architecture-overview.md  # 本文档
```
