# 代码审计报告




## 1. 漏洞简介


**漏洞名称**：产品属性模块 - 存储型XSS漏洞



**漏洞描述**：
在_ProductAttributes.cshtml视图中，产品属性描述通过Html.Raw直接输出到HTML页面，未进行编码或过滤，导致存储型XSS漏洞。管理员可在后台设置包含恶意脚本的产品属性描述，该脚本将在前端页面执行，影响浏览产品的普通用户。





## 2. 漏洞原理
1. **漏洞入口点**：管理员在后台设置产品属性描述
   - 文件：`src/Presentation/Nop.Web/Areas/Admin/Controllers/ProductAttributeController.cs:67-70`
   ```csharp
   await _localizedEntityService.SaveLocalizedValueAsync(productAttribute,
       x => x.Description,
       localized.Description,  // 用户输入的描述内容，未进行HTML编码
       localized.LanguageId);
   ```

1.1. **输入验证缺失**：ProductAttributeValidator未对Description字段进行XSS防护
   - 文件：`src/Presentation/Nop.Web/Areas/Admin/Validators/Catalog/ProductAttributeValidator.cs:10-15`
   ```csharp
   public partial class ProductAttributeValidator : BaseNopValidator<ProductAttributeModel>
   {
       public ProductAttributeValidator(ILocalizationService localizationService)
       {
           RuleFor(x => x.Name).NotEmpty(); // 仅验证Name字段非空
           // Description字段无任何验证规则
       }
   }
   ```

2. **危险输出点**：前端页面直接输出未编码的HTML内容
   - 文件：`src/Presentation/Nop.Web/Views/Product/_ProductAttributes.cshtml:30`
   ```html
   <div class="attribute-description">
       @Html.Raw(attribute.Description)  <!-- 直接输出未编码的HTML -->
   </div>
   ```

2.1. **数据流路径**：
   - 管理员输入 → `ProductAttributeController.UpdateLocalesAsync()` → 数据库存储 → `ProductModelFactory` → `_ProductAttributes.cshtml` → `Html.Raw()`输出





## 3. 漏洞风险


**风险等级：**MEDIUM



**风险描述：**
**漏洞确认**：该存储型XSS漏洞确实存在且可被利用。

**攻击条件**：
- 攻击者需要获得管理员权限才能注入恶意脚本
- 一旦获得管理员权限，利用过程简单直接
- 恶意脚本存储在数据库中，影响所有浏览相关产品的用户

**实际风险**：
- 虽然需要管理员权限，但在实际攻击场景中，攻击者可能通过社会工程、凭证泄露等方式获得管理员权限
- 一旦注入成功，所有浏览受影响产品的用户都会执行恶意脚本
- 可窃取用户会话Cookie、重定向到恶意网站、执行钓鱼攻击等

**风险评估**：风险等级为MEDIUM，因为虽然需要管理员权限（中等难度），但一旦利用成功，危害程度高。







## 4. 漏洞复现


**复现前提**：
- 需要管理员权限访问后台管理系统
- 目标系统需启用产品属性功能
- 需要至少一个可编辑的产品属性
- 浏览器需启用JavaScript
- 普通用户需要能够浏览包含产品属性的商品页面



**复现难度评估：**中 - 需要管理员权限，但一旦获得权限，利用过程简单直接



**复现POC**：
**复现步骤**：
1. 以管理员身份登录后台管理系统
2. 进入"目录" → "产品属性" → 编辑任意产品属性
3. 在描述字段中插入XSS payload：
```html
<script>alert('XSS')</script>
```
4. 保存产品属性
5. 访问包含该产品属性的商品页面
6. 观察浏览器弹出警告框，证明XSS执行成功

**高级检测脚本**：
```javascript
// 作为管理员，在产品属性描述中插入检测脚本：
<script>
// 检测当前页面是否易受XSS攻击
if (document.querySelector('.attribute-description script')) {
    console.log('XSS漏洞确认：产品属性描述字段存在未过滤的脚本');
    // 可进一步执行恶意操作
    fetch('/api/steal-cookies?cookie=' + document.cookie);
}
</script>```





## 5. 修复方案
**修复方案**：

1. **立即修复**：移除Html.Raw，使用安全输出方式
   - 文件：`src/Presentation/Nop.Web/Views/Product/_ProductAttributes.cshtml:30`
   ```csharp
   // 危险代码：
   @Html.Raw(attribute.Description)
   
   // 安全代码（方案1 - HTML编码）：
   @Html.Raw(HttpUtility.HtmlEncode(attribute.Description))
   
   // 安全代码（方案2 - 使用Razor默认编码）：
   @attribute.Description  <!-- Razor默认会对HTML特殊字符进行编码 -->
   ```

2. **输入验证**：在后台添加HTML内容过滤
   - 文件：`src/Presentation/Nop.Web/Areas/Admin/Controllers/ProductAttributeController.cs`
   ```csharp
   // 在保存前过滤危险标签
   var sanitizedDescription = SanitizeHtml(localized.Description);
   await _localizedEntityService.SaveLocalizedValueAsync(productAttribute,
       x => x.Description,
       sanitizedDescription,
       localized.LanguageId);
   ```

3. **白名单过滤**：使用HTML净化库
   - 安装HtmlSanitizer NuGet包
   ```csharp
   using Ganss.Xss;
   
   private string SanitizeHtml(string html)
   {
       var sanitizer = new HtmlSanitizer();
       sanitizer.AllowedTags.Add("b");
       sanitizer.AllowedTags.Add("i");
       sanitizer.AllowedTags.Add("u");
       sanitizer.AllowedTags.Add("br");
       sanitizer.AllowedTags.Add("p");
       // 仅允许安全的HTML标签
       return sanitizer.Sanitize(html);
   }
   ```

4. **深度防御**：添加内容安全策略(CSP)
   - 在web.config或中间件中添加CSP头限制脚本执行
